name: Deploy Chat Application to AWS EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_chatbot_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.8
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
    
    - name: Set up test database
      run: |
        export DATABASE_URL="postgresql://postgres:rsamriddhi1234@rsamriddhi.c3ea24kmsrmf.ap-south-1.rds.amazonaws.com:5432/rsamriddhi"
        python -c "
        from models import db
        if db.connect():
            db.create_tables()
            print('Test database setup successful')
            db.disconnect()
        else:
            print('Test database setup failed')
            exit(1)
        "
      env:
        DATABASE_URL: postgresql://postgres:rsamriddhi1234@rsamriddhi.c3ea24kmsrmf.ap-south-1.rds.amazonaws.com:5432/rsamriddhi
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SECRET_KEY: test-secret-key
        FLASK_ENV: testing
    
    - name: Run tests
      run: |
        export DATABASE_URL="postgresql://postgres:postgres@localhost:5432/test_chatbot_db"
        python -m pytest tests/ -v --cov=app --cov-report=xml
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_chatbot_db
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        SECRET_KEY: test-secret-key
        FLASK_ENV: testing
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          echo "ðŸš€ Starting automated deployment..."
          echo "=================================="
          
          # Update system packages
          echo "ðŸ“¦ Updating system packages..."
          sudo apt update && sudo apt upgrade -y
          
          # Install essential packages if not present
          echo "ðŸ”§ Installing essential packages..."
          sudo apt install -y python3 python3-pip python3-venv python3-dev build-essential libpq-dev postgresql postgresql-contrib nginx git curl wget
          
          # Start and enable services
          echo "ðŸ”„ Starting services..."
          sudo systemctl start postgresql
          sudo systemctl enable postgresql
          sudo systemctl start nginx
          sudo systemctl enable nginx
          
          # Create application directory if it doesn't exist
          echo "ðŸ“ Setting up application directory..."
          sudo mkdir -p /var/www/chatbot-app
          sudo chown ubuntu:ubuntu /var/www/chatbot-app
          
          # Navigate to application directory
          cd /var/www/chatbot-app
          
          # Clone or update repository
          if [ ! -d ".git" ]; then
            echo "ðŸ“¥ Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git .
          else
            echo "ðŸ”„ Pulling latest changes..."
            git pull origin main
          fi
          
          # Set up Python virtual environment
          echo "ðŸ Setting up Python environment..."
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          source venv/bin/activate
          
          # Install/update dependencies
          echo "ðŸ“š Installing Python dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Set up PostgreSQL database
          echo "ðŸ—„ï¸ Setting up database..."
          sudo -u postgres psql -c "CREATE DATABASE chatbot_db;" 2>/dev/null || echo "Database already exists"
          sudo -u postgres psql -c "CREATE USER chatbot_user WITH PASSWORD 'secure_password_123';" 2>/dev/null || echo "User already exists"
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE chatbot_db TO chatbot_user;" 2>/dev/null || echo "Privileges already granted"
          sudo -u postgres psql -c "ALTER USER chatbot_user CREATEDB;" 2>/dev/null || echo "User already has CREATEDB"
          
          # Set up environment variables
          echo "âš™ï¸ Configuring environment..."
          cat > .env << EOF
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          DATABASE_URL=postgresql://chatbot_user:secure_password_123@localhost:5432/chatbot_db
          FLASK_ENV=production
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          PORT=5000
          HOST=0.0.0.0
          EOF
          
          # Run database setup
          echo "ðŸ—ƒï¸ Setting up database tables..."
          python -c "
          from models import db
          if db.connect():
              db.create_tables()
              print('Database tables created successfully')
              db.disconnect()
          else:
              print('Database connection failed')
              exit(1)
          "
          
          # Create systemd service file
          echo "ðŸ”§ Creating systemd service..."
          sudo tee /etc/systemd/system/chatbot-app.service > /dev/null << EOF
          [Unit]
          Description=Chatbot Application
          After=network.target postgresql.service
          Requires=postgresql.service
          
          [Service]
          Type=exec
          User=ubuntu
          Group=ubuntu
          WorkingDirectory=/var/www/chatbot-app
          Environment=PATH=/var/www/chatbot-app/venv/bin
          ExecStart=/var/www/chatbot-app/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 3 app:app
          ExecReload=/bin/kill -s HUP \$MAINPID
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Create Nginx configuration
          echo "ðŸŒ Configuring Nginx..."
          sudo tee /etc/nginx/sites-available/chatbot-app > /dev/null << EOF
          server {
              listen 80;
              server_name _;
              
              location / {
                  proxy_pass http://127.0.0.1:5000;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
              
              location /static {
                  alias /var/www/chatbot-app/static;
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
              
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-XSS-Protection "1; mode=block" always;
              add_header X-Content-Type-Options "nosniff" always;
          }
          EOF
          
          # Enable Nginx site
          sudo ln -sf /etc/nginx/sites-available/chatbot-app /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          
          # Test Nginx configuration
          sudo nginx -t
          
          # Reload systemd and start services
          echo "ðŸ”„ Starting application services..."
          sudo systemctl daemon-reload
          sudo systemctl enable chatbot-app
          sudo systemctl restart chatbot-app
          sudo systemctl reload nginx
          
          # Wait for services to start
          sleep 15
          
          # Check service status
          echo "ðŸ“Š Checking service status..."
          sudo systemctl status chatbot-app --no-pager
          sudo systemctl status nginx --no-pager
          
          # Test application health
          echo "ðŸ¥ Testing application health..."
          for i in {1..5}; do
            if curl -f http://localhost:5000/api/health; then
              echo "âœ… Application is healthy!"
              break
            else
              echo "â³ Waiting for application to start... (attempt $i/5)"
              sleep 10
            fi
          done
          
          # Final status check
          echo "ðŸŽ¯ Final deployment status:"
          echo "Application URL: http://${{ secrets.EC2_HOST }}"
          echo "Health Check: http://${{ secrets.EC2_HOST }}/api/health"
          echo "Service Status:"
          sudo systemctl is-active chatbot-app
          sudo systemctl is-active nginx
          sudo systemctl is-active postgresql
          
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "=================================="

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify deployment status
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: always() && secrets.SLACK_WEBHOOK
